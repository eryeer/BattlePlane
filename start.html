<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Battle Plane</title>
<script type="text/javascript" src="./js/jquery-1.8.3.min.js"></script>
<script type="text/javascript">
jQuery(function($){
	//设定分数
	var point = 0;
	//设定子弹等级
	var weapon = 2;
	//飞机移动设定
	$("body").on("keydown",function(e){
		if ($("#me").is(":animated")) {
			return false;
		}else{
			if (e.which == 39) {
				$("#me").animate({
					left : "+=35px"
				},100);
			} else if (e.which == 38) {
				$("#me").animate({
					top : "-=25px"
				},100);
			} else if (e.which == 37) {
				$("#me").animate({
					left : "-=35px"
				},100);
			} else if (e.which == 40) {
				$("#me").animate({
					top : "+=25px"
				},100);
			} 
		}
		//飞机开炮设定
	}).on("keydown",function(e){
		if (e.which == 32) {
			if (weapon == 1) {
				$("body")
				.append("<embed src='./sound/bullet.mp3' hidden='true' autostart='true'>")
				.append("<img src='./img/bullet.png'>")
				.children("img:last")
				.addClass("bullet")
				.offset({
					top : $("#me").offset().top,
					left : $("#me").offset().left+45 
				})
				.animate({
					top : "-=500px"
				},"normal",function(){
					$(this).remove();
				});	
			}else if (weapon == 2){
				$("body")
				.append("<embed src='./sound/bullet.mp3' hidden='true' autostart='true'>")
				.append("<img src='./img/bullet.png'>")
				.children("img:last")
				.addClass("bullet")
				.offset({
					top : $("#me").offset().top,
					left : $("#me").offset().left+25 
				})
				.animate({
					top : "-=500px"
				},"normal",function(){
					$(this).remove();
				});	
				
				$("body")
				.append("<img src='./img/bullet.png'>")
				.children("img:last")
				.addClass("bullet")
				.offset({
					top : $("#me").offset().top,
					left : $("#me").offset().left+65 
				})
				.animate({
					top : "-=500px"
				},"normal",function(){
					$(this).remove();
				});	
			}
		}
	});
	
	//目标的运动设定 简单模式
	function targetMotionLevel1(){
		$("body")
		.append("<img src='./img/target.png' class='target'>")
		.children("img[class=target]:last")
		.animate({
			left : "+=1100px"
		},4000,function(){
			$(this).remove();
		});
	}
	
	//目标的运动设定 困难模式
	function targetMotionLevel2(){
		var des_x = $("#me").offset().left;
		var des_y = $("#me").offset().top;
		var begin_x = ($(window).width())*(Math.random());
		var begin_y = 0;
		$("body")
		.append("<img src='./img/target.png' class='target'>")
		.children("img[class=target]:last")
		.offset({
			top : begin_y,
			left : begin_x
		}) 
		.animate({
			left : des_x,
			top : des_y
		},2000,"linear",function(){
			$(this).remove();
		});
	}
	
	//击中检查 param:小物体,大物体,命中后的函数
	function scanner($small,$big,fn){
		//检查元素重合 param:检查点x坐标,检查点y坐标,左上参考点x坐标,左上参考点y坐标,右下参考点x坐标,右下参考点y坐标
		function checkIn(checkPoint_x,checkPoint_y,topLeft_x,topLeft_y,bottomRight_x,bottomRight_y){
			if(checkPoint_x > topLeft_x && checkPoint_x < bottomRight_x
				&& checkPoint_y < bottomRight_y &&checkPoint_y > topLeft_y){
				return true;
			}
			return false;
		}
		$small.each(function(i,b){
			$big.each(function(j,t){
				var $b = $(b);
				var $t = $(t);
				//子弹从左上开始顺时针四个角的点
				var p1_x,p1_y,p2_x,p2_y,p3_x,p3_y,p4_x,p4_y;
				p1_x = $b.offset().left;
				p1_y = $b.offset().top;
				p2_x = p1_x + $b.width();
				p2_y = p1_y;
				p3_x = p2_x;
				p3_y = p2_y + $b.height();
				p4_x = p1_x;
				p4_y = p1_y + $b.height();
				//console.log(p1_x+":"+p1_y+";"+p2_x+":"+p2_y+";"+p3_x+":"+p3_y+";"+p4_x+":"+p4_y);
				//目标左上坐标
				var tl_x,tl_y;
				tl_x = $t.offset().left;
				tl_y = $t.offset().top;
				//目标右下坐标
				var br_x,br_y;
				br_x = tl_x + $t.width();
				br_y = tl_y + $t.height();
				//判断四个点是否在目标内部
				var in1 = checkIn(p1_x,p1_y,tl_x,tl_y,br_x,br_y);
				var in2 = checkIn(p2_x,p2_y,tl_x,tl_y,br_x,br_y);
				var in3 = checkIn(p3_x,p3_y,tl_x,tl_y,br_x,br_y);
				var in4 = checkIn(p4_x,p4_y,tl_x,tl_y,br_x,br_y);
				if(in1 || in2 || in3 || in4){
					//击中后处理
					fn($b,$t);
				}
			});
		});
	}
	
	//击溃处理  param:小物体,大物体,音效,击溃图片的jquey数组
	function defeated($small,$big,$music,pic_array){
		$("body").append($music);
		$small.remove();
	 	var loc_x = $big.offset().left;
		var loc_y = $big.offset().top;
		$big.remove();
		for ( var i = 0; i < pic_array.length; i++) {
			pic_array[i].appendTo("body")
			.offset({
				top : loc_y,
				left : loc_x 
			})
			.css("z-index",pic_array.length-i) 
			.animate({
				height : "+=10px",
				width : "+=10px",
				left : "-=5px",
				top : "-=5px",
			},(i+1)*50,function(){
				$(this).remove();
			});
		} 
	}
	
	//计分器
	function counter(){
		if(point >= 99999){
			return;
		}
		point += 10;
		$("#panel span:first").text(point);
	}
	
	//生成目标
	var timer_produce = setInterval(targetMotionLevel2,1000);
	//扫描击中目标
	var timer_hit = setInterval(function(){
		scanner($("img[class=bullet]"),$("img[class=target]"),function($b,$t){
			var $pic1 = $("<img class='boom' src='./img/enemy0_down1.png'>");
			var $pic2 = $("<img class='boom' src='./img/enemy0_down2.png'>");
			var $pic3 = $("<img class='boom' src='./img/enemy0_down3.png'>");
			var $pic4 = $("<img class='boom' src='./img/enemy0_down4.png'>");
			var pic_array = [$pic1,$pic2,$pic3,$pic4];
			defeated($b,$t,$("<embed src='./sound/enemy0_down.mp3' hidden='true' autostart='true'>"),pic_array);
			counter();
		});	
	},16);
	//扫描自己被击中
	var timer_over = setInterval(function(){
		scanner($("img[class=target]"),$("#me"),function($t,$m){
			var $pic1 = $("<img class='heroboom' src='./img/hero_blowup_n1.png'>");
			var $pic2 = $("<img class='heroboom' src='./img/hero_blowup_n2.png'>");
			var $pic3 = $("<img class='heroboom' src='./img/hero_blowup_n3.png'>");
			var pic_array = [$pic1,$pic2,$pic3];
			defeated($t,$m,$("<embed src='./sound/game_over.mp3' hidden='true' autostart='true'>"),pic_array);
			//背景乐停止
			$("#bgsound").remove();
			//按键触发无效
			$("body").off("keydown"); 
			//停止扫描
			clearInterval(timer_produce);
			clearInterval(timer_hit);
			clearInterval(timer_over);
		});
	},30);
});
</script>
<style type="text/css">
#panel{
	border:3px solid black;
	width:80px;
	height:45px;
	text-align:center;
	line-height:45px;
	overflow:hidden
}
#panel span{
	font-size: 20px;
	font-family: "黑体"
}
#cat {
	width: 100px;
	height: 124px
}

#me {
	position: absolute;
	top: 500px;
	left: 600px;
	overflow: hidden;
	z-index: 1
}

.bullet {
	position: absolute;
	width: 13px;
	height: 25px;
}

.boom{
	position: absolute;
	width: 50px;
	height: 50px;
}
.heroboom{
	position: absolute;
	width: 100px;
	height: 124px;
}
.target {
	position: absolute;
	width: 50px;
	height: 50px;
	top: 50px;
	left: 50px;
	z-index: 2;
}
</style>
</head>
<body>
	<div id="panel"><strong><span>0</span><span>分</span></strong><div>
	<div id="me">
		<img id="cat" src="./img/me.png" alt="cat">
	</div>
	<audio src="./sound/game_music.mp3" id="bgsound" hidden="true" autoplay="true" loop="true"></audio>
</body>
</html>